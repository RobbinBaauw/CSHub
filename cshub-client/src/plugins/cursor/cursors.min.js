import rangeFix from"rangefix";import tinycolor from"tinycolor2";var DEFAULTS={template:['<span class="ql-cursor-selections"></span>','<span class="ql-cursor-caret-container">','  <span class="ql-cursor-caret"></span>',"</span>",'<div class="ql-cursor-flag">','  <small class="ql-cursor-name"></small>','  <span class="ql-cursor-flag-flap"></span>',"</div>"].join(""),autoRegisterListener:!0,hideDelay:3e3,hideSpeed:400};function QuillCursors(t,e){this.quill=t,this._initOptions(e),this.cursors={},this.currScrollTop=this.quill.root.scrollTop,this.container=this.quill.addContainer("ql-cursors"),this.options.autoRegisterListener&&this.registerTextChangeListener(),window.addEventListener("resize",this.update.bind(this))}QuillCursors.prototype.registerTextChangeListener=function(){this.quill.on(this.quill.constructor.events.TEXT_CHANGE,this._applyDelta.bind(this))},QuillCursors.prototype.clearCursors=function(){Object.keys(this.cursors).forEach(this.removeCursor.bind(this))},QuillCursors.prototype.moveCursor=function(t,e){var r=this.cursors[t];r&&(r.range=e,r.el.classList.remove("hidden"),this._updateCursor(r))},QuillCursors.prototype.removeCursor=function(t){var e=this.cursors[t];e&&e.el.parentNode.removeChild(e.el),delete this.cursors[t]},QuillCursors.prototype.setCursor=function(t,e,r,s){return this.cursors[t]||(this.cursors[t]={userId:t,color:s,range:e,el:null,selectionEl:null,caretEl:null,flagEl:null},this._buildCursor(t,r)),window.setTimeout(function(){this.moveCursor(t,e)}.bind(this)),this.cursors[t]},QuillCursors.prototype.shiftCursors=function(t,e){var r;Object.keys(this.cursors).forEach(function(s){(r=this.cursors[s])&&r.range&&(e>0||0==r.range.length?this._shiftCursor(s,t-1,e):this._shiftCursor(s,t,e))},this)},QuillCursors.prototype.update=function(){Object.keys(this.cursors).map(function(t){this._updateCursor(this.cursors[t])}.bind(this))},QuillCursors.prototype._initOptions=function(t){this.options=DEFAULTS,this.options.template=t.template||this.options.template,this.options.autoRegisterListener=0==t.autoRegisterListener?t.autoRegisterListener:this.options.autoRegisterListener,this.options.hideDelay=null==t.hideDelay?this.options.hideDelay:t.hideDelay,this.options.hideSpeed=null==t.hideSpeed?this.options.hideSpeed:t.hideSpeed},QuillCursors.prototype._applyDelta=function(t){var e=0;t.ops.forEach(function(t){var r=0;t.insert?(r=t.insert.length||1,this.shiftCursors(e,r)):t.delete?this.shiftCursors(e,-1*t.delete):t.retain&&(r=t.retain),e+=r},this),this.update()},QuillCursors.prototype._buildCursor=function(t,e){var r,s,o,i=this.cursors[t],l=document.createElement("span");l.classList.add("ql-cursor"),l.innerHTML=this.options.template,r=l.querySelector(".ql-cursor-selections"),s=l.querySelector(".ql-cursor-caret-container"),(o=l.querySelector(".ql-cursor-flag")).style.backgroundColor=i.color,s.querySelector(".ql-cursor-caret").style.backgroundColor=i.color,this.quill.root.addEventListener("scroll",()=>{o.style.marginTop=`${this.currScrollTop-this.quill.root.scrollTop}px`,s.style.marginTop=`${this.currScrollTop-this.quill.root.scrollTop}px`}),l.querySelector(".ql-cursor-name").innerText=e,o.style.transitionDelay=this.options.hideDelay+"ms",o.style.transitionDuration=this.options.hideSpeed+"ms",this.container.appendChild(l),i.el=l,i.selectionEl=r,i.caretEl=s,i.flagEl=o},QuillCursors.prototype._shiftCursor=function(t,e,r){var s=this.cursors[t];s.range.index>e&&(s.range.index+=r)},QuillCursors.prototype._hideCursor=function(t){var e=this.cursors[t];e&&e.el.classList.add("hidden")},QuillCursors.prototype._updateCursor=function(t){if(t&&t.range){var e=t.range.index,r=t.range.index+t.range.length;r>this.quill.getLength()-1&&(r=this.quill.getLength()-1);var s,o=this.quill.container.getBoundingClientRect(),i=this.quill.getLeaf(e),l=this.quill.getLeaf(r),n=document.createRange();if(!i||!l||!i[0]||!l[0]||i[1]<0||l[1]<0||!i[0].domNode||!l[0].domNode)return console.warn("[quillInstance-cursors] A cursor couldn't be updated (ID "+t.userId+"), hiding."),void this._hideCursor(t.userId);n.setStart(i[0].domNode,i[1]),n.setEnd(l[0].domNode,l[1]),s=rangeFix.getClientRects(n),this._updateCaret(t,l),this._updateSelection(t,s,o)}},QuillCursors.prototype._updateCaret=function(t,e){var r,s=t.range.index+t.range.length;s>0&&0===e[1]&&t.range.index!==t.range.index+t.range.length&&s--,r=this.quill.getBounds(s),t.caretEl.style.top=r.top+"px",t.caretEl.style.left=r.left+"px",t.caretEl.style.height=r.height+"px",t.caretEl.style.marginTop="0px",t.flagEl.style.top=r.top+"px",t.flagEl.style.left=r.left+"px",t.flagEl.style.marginTop="0px"},QuillCursors.prototype._updateSelection=function(t,e,r){const s=e=>{var s=document.createElement("span");return s.classList.add("ql-cursor-selection-block"),s.style.top=e.top-r.top+"px",s.style.left=e.left-r.left+"px",s.style.width=e.width+"px",s.style.height=e.height+"px",s.style.backgroundColor=tinycolor(t.color).setAlpha(.3).toString(),this.currScrollTop=this.quill.root.scrollTop,this.quill.root.addEventListener("scroll",()=>{s.style.marginTop=`${this.currScrollTop-this.quill.root.scrollTop}px`}),s};t.selectionEl.innerHTML=null;var o,i=[];[].forEach.call(e,function(e){o=""+e.top+e.left+e.width+e.height,!~i.indexOf(o)&&e.width>1&&(i.push(o),t.selectionEl.appendChild(s(e)))},this)};export default QuillCursors;