export class ImageResize{constructor(quill,options={}){this.quill=quill;this.options=options;this.handleClick=this.handleClick.bind(this);this.handleMousedown=this.handleMousedown.bind(this);this.handleMouseup=this.handleMouseup.bind(this);this.handleDrag=this.handleDrag.bind(this);this.checkImage=this.checkImage.bind(this);this.boxes=[];document.execCommand("enableObjectResizing",false,"false");this.quill.root.addEventListener("click",this.handleClick,false)}handleClick(evt){if(evt.target&&evt.target.tagName&&evt.target.tagName.toUpperCase()==="IMG"){if(this.img===evt.target){return}if(this.img){this.hide()}this.show(evt.target)}else if(this.img){this.hide()}}show(img){this.img=img;this.showResizers();this.showSizeDisplay();const rect=this.img.getBoundingClientRect();this.positionBoxes(rect);this.positionSizeDisplay(rect)}hide(){this.hideResizers();this.hideSizeDisplay();this.img=undefined}showResizers(){this.setUserSelect("none");this.addBox("nwse-resize");this.addBox("nesw-resize");this.addBox("nwse-resize");this.addBox("nesw-resize");document.addEventListener("keyup",this.checkImage,true);this.quill.root.addEventListener("input",this.checkImage,true)}hideResizers(){document.removeEventListener("keyup",this.checkImage);this.quill.root.removeEventListener("input",this.checkImage);this.setUserSelect("");this.setCursor("");this.boxes.forEach(box=>document.body.removeChild(box));this.dragBox=undefined;this.dragStartX=undefined;this.preDragWidth=undefined;this.boxes=[]}addBox(cursor){const box=document.createElement("div");const styles={position:"absolute",height:"12px",width:"12px",backgroundColor:"white",border:"1px solid #777",boxSizing:"border-box",opacity:"0.80",cursor:cursor};this.extend(box.style,styles,this.options.handleStyles||{});box.addEventListener("mousedown",this.handleMousedown,false);document.body.appendChild(box);this.boxes.push(box)}extend(destination,...sources){sources.forEach(source=>{for(let prop in source){if(source.hasOwnProperty(prop)){destination[prop]=source[prop]}}});return destination}positionBoxes(rect){[{left:rect.left-6,top:rect.top-6},{left:rect.left+rect.width-6,top:rect.top-6},{left:rect.left+rect.width-6,top:rect.top+rect.height-6},{left:rect.left-6,top:rect.top+rect.height-6}].forEach((pos,idx)=>{this.extend(this.boxes[idx].style,{top:Math.round(pos.top+window.pageYOffset)+"px",left:Math.round(pos.left+window.pageXOffset)+"px"})})}handleMousedown(evt){this.dragBox=evt.target;this.dragStartX=evt.clientX;this.preDragWidth=this.img.width||this.img.naturalWidth;this.setCursor(this.dragBox.style.cursor);document.addEventListener("mousemove",this.handleDrag,false);document.addEventListener("mouseup",this.handleMouseup,false)}handleMouseup(){this.setCursor("");document.removeEventListener("mousemove",this.handleDrag);document.removeEventListener("mouseup",this.handleMouseup)}handleDrag(evt){if(!this.img){return}if(this.dragBox===this.boxes[0]||this.dragBox===this.boxes[3]){this.img.width=Math.round(this.preDragWidth-evt.clientX-this.dragStartX)}else{this.img.width=Math.round(this.preDragWidth+evt.clientX-this.dragStartX)}const rect=this.img.getBoundingClientRect();this.positionBoxes(rect);this.positionSizeDisplay(rect)}setUserSelect(value){["userSelect","mozUserSelect","webkitUserSelect","msUserSelect"].forEach(prop=>{this.quill.root.style[prop]=value;document.documentElement.style[prop]=value})}setCursor(value){[document.body,this.img,this.quill.root].forEach(function(e1){e1.style.cursor=value})}checkImage(){if(this.img){this.hide()}}showSizeDisplay(){if(!this.options.displaySize){return}this.display=document.createElement("div");const styles={position:"absolute",font:"12px/1.0 Arial, Helvetica, sans-serif",padding:"4px 8px",textAlign:"center",backgroundColor:"white",color:"#333",border:"1px solid #777",boxSizing:"border-box",opacity:"0.80",cursor:"default"};this.extend(this.display.style,styles,this.options.displayStyles||{});document.body.appendChild(this.display)}hideSizeDisplay(){document.body.removeChild(this.display);this.display=undefined}positionSizeDisplay(rect){if(!this.display||!this.img){return}const size=this.getCurrentSize();this.display.innerHTML=size.join(" &times ");if(size[0]>120&&size[1]>30){const dispRect=this.display.getBoundingClientRect();this.extend(this.display.style,{left:Math.round(rect.left+rect.width+window.pageXOffset-dispRect.width-8)+"px",top:Math.round(rect.top+rect.height+window.pageYOffset-dispRect.height-8)+"px"})}else{this.extend(this.display.style,{left:Math.round(rect.left+rect.width+window.pageXOffset+8)+"px",top:Math.round(rect.top+rect.height+window.pageYOffset+8)+"px"})}}getCurrentSize(){return[this.img.width,Math.round(this.img.width/this.img.naturalWidth*this.img.naturalHeight)]}};
