language: node_js
node_js:
  - "11"
services:
  - docker

stages:
  - shared
  - others

matrix:
  include:
    - name: "shared-push"
      stage: shared
      if: type = push
      script:
        - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
        - docker build -t $DOCKER_USERNAME/shared:$TRAVIS_BRANCH cshub-shared
        - docker push $DOCKER_USERNAME/shared:$TRAVIS_BRANCH

    - name: "client-push"
      if: type = push
      stage: others
      before_script:
        - cd cshub-client
        - node version.js
        - cd ..
      script:
        - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
        - docker build --build-arg BASE_IMAGE=$DOCKER_USERNAME/shared:$TRAVIS_BRANCH -t $DOCKER_USERNAME/client:$TRAVIS_BRANCH cshub-client
        - docker push $DOCKER_USERNAME/client:$TRAVIS_BRANCH

    - name: "server-push"
      if: type = push
      stage: others
      script:
        - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
        - docker build --build-arg BASE_IMAGE=$DOCKER_USERNAME/shared:$TRAVIS_BRANCH -t $DOCKER_USERNAME/server:$TRAVIS_BRANCH cshub-server
        - docker push $DOCKER_USERNAME/server:$TRAVIS_BRANCH

    - name: "client-pull"
      if: type = pull_request
      stage: others
      script:
        - docker build -t shared-$TRAVIS_PULL_REQUEST_SHA cshub-shared
        - docker build --build-arg BASE_IMAGE=shared-$TRAVIS_PULL_REQUEST_SHA cshub-client

    - name: "server-pull"
      if: type = pull_request
      stage: others
      script:
        - docker build -t shared-$TRAVIS_PULL_REQUEST_SHA cshub-shared
        - docker build --build-arg BASE_IMAGE=shared-$TRAVIS_PULL_REQUEST_SHA cshub-server

